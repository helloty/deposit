<!DOCTYPE html>
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<html lang="en" class="no-js">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>首页</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/animate.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
</head>

<body>
<header id="main">
    <section class="hero">
        <div class="container">
            <div class="row nav-wrapper">
                <div class="col-md-6 col-sm-6 col-xs-6 text-left" style="font-size: 22px;color:#fff;font-weight: bold;">
                    CLASS DEPOSIT
                </div>
                <div class="col-md-6 col-sm-6 col-xs-6 text-left job-menu" style="font-size: 16px;">
                    <div class="item">
                        <a href="#info" class="animated fadeInUp">记一笔</a>
                    </div>
                    <div class="item">
                        <a href="#info" class="animated fadeInUp">班级账本</a>
                    </div>
                </div>
            </div>
            <div class="row hero-content">
                <div class="col-md-12 text-center" style="margin-top: 10%">
                    <h1 class="animated fadeInDown">班费管理，如此简单!</h1>
                    <a href="#info" class="read-btn animated fadeInUp">开启</a>

                    <h1 id="noExtension" style="display: none">请安装
                        <a target="_blank"
                           href="https://github.com/ChengOrangeJu/WebExtensionWallet">WebExtensionWallet</a> 再使用</h1>
                </div>
            </div>
        </div>
    </section>
</header>
<section class="services-list" id="info">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="col-md-4 feature-1 wp2">
                    <div class="feature-content">
                        <img src="img/a.png" alt="">
                        <h1>安全</h1>
                        <p>基于新一代公链星云链加密</p>
                    </div>
                </div>
                <div class="col-md-4 feature-3 wp2 delay-05s">
                    <div class="feature-content">
                        <img src="img/b.png" alt="">
                        <h1>简单</h1>
                        <p>无需注册,基于钱包地址</p>
                    </div>
                </div>
                <div class="col-md-4 feature-2 wp2 delay-1s">
                    <div class="feature-content">
                        <img src="img/c.png" alt="">
                        <h1>私密</h1>
                        <p>档案免实名</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="set" class="container page-section">
    <div class="inner contact wp2 delay-05s">

        <div class="contact-form" style="overflow:hidden;display: none" id="createAccount">
            <div class="relative fullwidth col-xs-12">
                <button id="search" class="form-btn semibold">创建</button>
            </div>
            <div class="clear"></div>
        </div>
        <div style="height: 30px;"></div>
        <div style="overflow: hidden;height: 0;" class="myAccount">
            <div id="main1" style="width: 50%;height:300px;float: left;"></div>
            <div id="main2" style="width: 50%;height:300px;float: left;">

                <div class="table-responsive" id="app" style="height: 100%;overflow-y: auto;">
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>类型</th>
                            <th>金额</th>
                            <th>时间</th>
                            <th>经办人</th>
                            <th>备注</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="l in list">
                            <td v-html="l.type"></td>
                            <td v-html="l.money"></td>
                            <td v-html="l.date"></td>
                            <td v-html="l.user"></td>
                            <td v-html="l.remark"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <form class="form-horizontal" style="margin-top: 50px;display: none;">
            <div class="form-group">
                <label class="col-sm-2 control-label">类型</label>
                <div class="col-sm-4">
                    <select class="form-control" id="xfType">
                        <option value="0">请选择</option>
                        <option value="1">采购</option>
                        <option value="2">活动</option>
                        <option value="3">奖励</option>
                        <option value="4">其他</option>
                    </select>
                </div>
                <label class="col-sm-2 control-label">金额</label>
                <div class="col-sm-4">
                    <input type="number" id="money" class="form-control" placeholder="请输入消费金额">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">时间</label>
                <div class="col-sm-4">
                    <input type="date" class="form-control" id="xfDate" placeholder="请选择时间">
                </div>
                <label class="col-sm-2 control-label">经办人</label>
                <div class="col-sm-4">
                    <input type="email" class="form-control" id="user" placeholder="请填写经办人">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">备注</label>
                <div class="col-sm-4">
                    <input type="email" class="form-control" id="remark" placeholder="备注">
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-2">
                    <button type="button" id="push" class="btn btn-primary col-sm-12">记录</button>
                </div>
            </div>
        </form>
    </div>
</section>
<footer id="about" class="footer">
    <section id="site-socials" class="no-padding white-bg">
        <div class="address socials animated fadeInRight visible" data-animation="fadeInRight"
             data-animation-delay="500">
            <p>Copyright &copy; 2018.基于新一代区块链公链<a href="https://nebulas.io/" target="_blank">NAS</a>&nbsp;&nbsp;&nbsp;
            </p>
        </div>
    </section>
</footer>

<script src=js/nebPay.js></script>
<script src="js/jquery.min.js"></script>
<script src="js/waypoints.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/scripts.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue"></script>
<script src="js/layer/layer.js" type="text/javascript" charset="utf-8"></script>
<script>
    $(function () {
        var NebPay = require("nebpay");
        var nebPay = new NebPay();

        var dappAddress = "n1fA8QdDQ378kVtPURfCjDEjv81EXF4n8Ju";
        //检查扩展是否已安装
        //如果安装了扩展，var“webExtensionWallet”将被注入到web页面中1
        setTimeout(function () {
            if (typeof (webExtensionWallet) === "undefined") {
                //alert ("扩展钱包未安装，请先安装.")
                $("#noExtension").show();
            }
        }, 500);

        var app = new Vue({
            el: '#app',
            data: {
                list: []
            }
        });
        var hasAccount = false;

        function search() {
            var to = dappAddress;
            var value = "0";
            var callFunction = "get";
            var callArgs = [];
            nebPay.simulateCall(to, value, callFunction, JSON.stringify(callArgs), {
                listener: cbSearch
            });
        }

        search();
        setInterval(function () {
            search();
        }, 10000);

        $('#createAccount').on('click', function () {
            $(this).hide();
            $('.form-horizontal').show();
            hasAccount=true;
        });

        function cbSearch(resp) {
            var result = resp.result
            if (result === 'null' || result == '') {
                myChart.setOption(option);
                $('.myAccount').css('height', '0');
                if (!hasAccount) {
                    $('#createAccount').show();
                }
            } else {
                myChart.setOption(option);
                $('.form-horizontal').show();
                $('.myAccount').css('height', 'auto');
                var resultObj = JSON.parse(result);
                var len = resultObj.value.split('|-').length;
                var obj = [];
                var obj2 = [];
                for (var i = 0; i < len; i++) {
                    var temp = {
                        value: resultObj.money.split('|-')[i],
                        name: getChartName(resultObj.value.split('|-')[i]),
                    }
                    obj.push(temp);

                    var temp2 = {
                        type: getChartName(resultObj.value.split('|-')[i]),
                        money: resultObj.money.split('|-')[i],
                        date: resultObj.date.split('|-')[i],
                        user: resultObj.user.split('|-')[i],
                        remark: resultObj.remark.split('|-')[i],
                    }
                    obj2.push(temp2);
                }
                myChart.setOption({
                    series: [{data: obj}]
                });

                Vue.set(app, 'list', obj2);
                $('#app').show();
            }

        }

        $("#push").click(function () {
            var xfType = $('#xfType').val();
            var money = $('#money').val();
            var xfDate = $('#xfDate').val();
            var user = $('#user').val();
            var remark = $('#remark').val();
            if (xfType == '0') {
                layer.msg('类型不能为空');
                return;
            } else if (money == '') {
                layer.msg('金额不能为空');
                return;
            } else if (xfDate === '') {
                layer.msg('时间不能为空');
                return;
            } else if (user == '') {
                layer.msg('经办人不能为空');
                return;
            }
            var to = dappAddress;
            var value = "0";
            var callFunction = "save"
            var callArgs = [];
            callArgs.push(xfType.toString());
            callArgs.push(money.toString());
            callArgs.push(xfDate);
            callArgs.push(user);
            callArgs.push(remark);
            nebPay.call(to, value, callFunction, JSON.stringify(callArgs), {
                listener: cbPush
            });
        });

        function cbPush(resp) {
            console.log("response of push: " + resp)
        }


    })
</script>
<script src="js/echarts.min.js"></script>
<script type="text/javascript">
    function getChartName(value) {
        if (value == 1) {
            return '采购';
        } else if (value == 2) {
            return '活动';
        } else if (value == 3) {
            return '奖励';
        } else if (value == 4) {
            return '其他';
        }
    }

    var myChart = echarts.init(document.getElementById('main1'));
    var option = {
        title: {
            text: '班费占比',
            x: 'center'
        },
        tooltip: {
            trigger: 'item',
            formatter: "{a} <br/>{b} : {c} ({d}%)"
        },
        legend: {
            orient: 'vertical',
            left: 'left',
            data: []
        },
        series: [
            {
                name: '支出类型',
                type: 'pie',
                radius: '55%',
                center: ['50%', '60%'],
                data: [],
                itemStyle: {
                    emphasis: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
    };

</script>
</body>

</html>